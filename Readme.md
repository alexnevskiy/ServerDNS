# DNS Server на UDP

В соответствии с RFC [1034](https://tools.ietf.org/html/rfc1034), [1035](https://tools.ietf.org/html/rfc1035) и [3596](https://tools.ietf.org/html/rfc3596) написан DNS сервер на *Java*, который принимает DNS-сообщения от клиентов, обрабатывает сообщения и выдаёт ответ на одну из 4 типов записей: *A*, *MX*, *TXT*, *AAAA*. Остальные типы записей игнорируются и отправляется сообщение с флагом `rcode` = 4. Сервер поддерживает множественную обработку вопросов (на практике не используется) и ответов (используется в *MX* записи).

## Реализация сервера

Для реализации модели DNS-сообщения написана модель, состоящая из множества [классов-сущностей](https://github.com/alexnevskiy/ServerDNS/tree/master/src/main/java/model), в котором описаны все используемые в протоколе поля.

При запуске сервера открывается сокет на 53 порту (дефолтный порт DNS) и ожидается сообщение от клиента. После получения пакета выставляется флаг `qr` в 1 (ответ сервера), и обрабатываются вопросы в сообщении. Если тип вопроса не совпадает с поддерживаемыми сервером, то выставляется флаг `rcode` = 4 и дейтаграмма отправляется обратно клиенту. Если же данный тип поддерживается, то к массиву байт добавляется ответ(-ы) и отправляется клиенту. Перед отправкой в терминале отображается содержимое пакета как в удобном виде (строкой), так и массивом байт. При вводе команды `-exit` сервер прекращает работу.

## Запуск сервера

Запуск сервера производится без каких-либо аргументов, однако во время работы он может принимать одну единственную команду:

- `-exit` - выключение сервера

## Примеры работы

### Встроенная в Windows утилита: nslookup

Первым DNS-сообщением nslookup всегда отправляет запрос с типом 12, который сервер игнорирует, поэтому во всех сообщениях от сервера содержится это сообщение с `rcode` = 4.

#### Тип A

Клиент:

```
nslookup -type=A google.com 127.0.0.1
╤хЁтхЁ:  UnKnown
Address:  127.0.0.1

Не заслуживающий доверия ответ:
╚ь :     49164
Address:  68.103.73.110
```

Сервер:

```
Header:
        ID: 1
        Flags:
                QR: 1
                OpCode: 0
                AA: 0
                TC: 0
                RD: 0
                RA: 0
                Z: 0
                RCODE: 4
        QDCOUNT: 1
        ANCOUNT: 0
        NSCOUNT: 0
        ARCOUNT: 0
Question:
        QNAME: [46, 46, 46, 52, 57, 53, 48, 46, 49, 48, 53, 49, 49, 48, 52, 53, 57, 55, 49, 48, 48, 49, 48, 48, 46, 57, 55, 49, 49, 52, 49, 49, 50]
        QTYPE: 12
        QCLASS: 1

Message bytes:
0 1 -128 4 0 1 0 0 0 0 0 0 0 0 0 4 52 57 53 48 16 49 48 53 49 49 48 52 53 57 55 49 48 48 49 48 48 8 57 55 49 49 52 49 49 50 0 0 12 0 1

Header:
        ID: 2
        Flags:
                QR: 1
                OpCode: 0
                AA: 0
                TC: 0
                RD: 0
                RA: 0
                Z: 0
                RCODE: 0
        QDCOUNT: 1
        ANCOUNT: 1
        NSCOUNT: 0
        ARCOUNT: 0
Question:
        QNAME: [49, 48, 51, 49, 49, 49, 49, 49, 49, 49, 48, 51, 49, 48, 56, 46, 57, 57, 49, 49, 49]
        QTYPE: 1
        QCLASS: 1
Answer:
        NAME: 49164
        TYPE: 1
        CLASS: 1
        TTL: 43200
        RDLENGTH: 4
        RDATA: DgInBQ==

Message bytes:
0 2 -128 0 0 1 0 1 0 0 0 0 15 49 48 51 49 49 49 49 49 49 49 48 51 49 48 56 5 57 57 49 49 49 0 0 1 0 1 5 52 57 49 54 52 0 0 1 0 1 0 0 -88 -64 0 4 68 103 73 110 66 81 61 61
```

#### Тип MX

Клиент:

```
nslookup -type=MX google.com 127.0.0.1
╤хЁтхЁ:  UnKnown
Address:  127.0.0.1

Не заслуживающий доверия ответ:
49164   MX preference = 1, mail exchanger = gB.4LJ.ih.2Z
49164   MX preference = 2, mail exchanger = hd9.mRGGy
49164   MX preference = 3, mail exchanger = qw6Wb.7g.Bk.Md0d
```

Сервер:

```
Header:
        ID: 1
        Flags:
                QR: 1
                OpCode: 0
                AA: 0
                TC: 0
                RD: 0
                RA: 0
                Z: 0
                RCODE: 4
        QDCOUNT: 1
        ANCOUNT: 0
        NSCOUNT: 0
        ARCOUNT: 0
Question:
        QNAME: [46, 46, 46, 52, 57, 53, 48, 46, 49, 48, 53, 49, 49, 48, 52, 53, 57, 55, 49, 48, 48, 49, 48, 48, 46, 57, 55, 49, 49, 52, 49, 49, 50]
        QTYPE: 12
        QCLASS: 1

Message bytes:
0 1 -128 4 0 1 0 0 0 0 0 0 0 0 0 4 52 57 53 48 16 49 48 53 49 49 48 52 53 57 55 49 48 48 49 48 48 8 57 55 49 49 52 49 49 50 0 0 12 0 1

Header:
        ID: 2
        Flags:
                QR: 1
                OpCode: 0
                AA: 0
                TC: 0
                RD: 0
                RA: 0
                Z: 0
                RCODE: 0
        QDCOUNT: 1
        ANCOUNT: 3
        NSCOUNT: 0
        ARCOUNT: 0
Question:
        QNAME: [49, 48, 51, 49, 49, 49, 49, 49, 49, 49, 48, 51, 49, 48, 56, 46, 57, 57, 49, 49, 49]
        QTYPE: 15
        QCLASS: 1
Answer:
        NAME: 49164
        TYPE: 15
        CLASS: 1
        TTL: 43200
        RDLENGTH: 16
        RDATA:  ☺☻gB♥4LJ☻ih☻2Z
Answer:
        NAME: 49164
        TYPE: 15
        CLASS: 1
        TTL: 43200
        RDLENGTH: 13
        RDATA:  ☻♥hd9♣mRGGy
Answer:
        NAME: 49164
        TYPE: 15
        CLASS: 1
        TTL: 43200
        RDLENGTH: 20
        RDATA:  ♥♣qw6Wb☻7g☻Bk♦Md0d

Message bytes:
0 2 -128 0 0 1 0 3 0 0 0 0 15 49 48 51 49 49 49 49 49 49 49 48 51 49 48 56 5 57 57 49 49 49 0 0 15 0 1 5 52 57 49 54 52 0 0 15 0 1 0 0 -88 -64 0 16 0 1 2 103 66 3 52 76 74 2 105 104 2 50 90 0 5 52 57 49 54 52 0 0 15 0 1 0 0 -88 -64 0 13 0 2 3 104 100 57 5 109 82 71 71 121 0 5 52 57 49 54 52 0 0 15 0 1 0 0 -88 -64 0 20 0 3 5 113 119 54 87 98 2 55 103 2 66 107 4 77 100 48 100 0
```

#### Тип TXT

Клиент:

```
nslookup -type=TXT google.com 127.0.0.1
╤хЁтхЁ:  UnKnown
Address:  127.0.0.1

Не заслуживающий доверия ответ:
49164   text =

        "WapVpNReS1msQxGwFCoE1Y90QOtiHoOwH0H7"
```

Сервер:

```
Header:
        ID: 1
        Flags:
                QR: 1
                OpCode: 0
                AA: 0
                TC: 0
                RD: 0
                RA: 0
                Z: 0
                RCODE: 4
        QDCOUNT: 1
        ANCOUNT: 0
        NSCOUNT: 0
        ARCOUNT: 0
Question:
        QNAME: [46, 46, 46, 52, 57, 53, 48, 46, 49, 48, 53, 49, 49, 48, 52, 53, 57, 55, 49, 48, 48, 49, 48, 48, 46, 57, 55, 49, 49, 52, 49, 49, 50]
        QTYPE: 12
        QCLASS: 1

Message bytes:
0 1 -128 4 0 1 0 0 0 0 0 0 0 0 0 4 52 57 53 48 16 49 48 53 49 49 48 52 53 57 55 49 48 48 49 48 48 8 57 55 49 49 52 49 49 50 0 0 12 0 1

Header:
        ID: 2
        Flags:
                QR: 1
                OpCode: 0
                AA: 0
                TC: 0
                RD: 0
                RA: 0
                Z: 0
                RCODE: 0
        QDCOUNT: 1
        ANCOUNT: 1
        NSCOUNT: 0
        ARCOUNT: 0
Question:
        QNAME: [49, 48, 51, 49, 49, 49, 49, 49, 49, 49, 48, 51, 49, 48, 56, 46, 57, 57, 49, 49, 49]
        QTYPE: 16
        QCLASS: 1
Answer:
        NAME: 49164
        TYPE: 16
        CLASS: 1
        TTL: 43200
        RDLENGTH: 37
        RDATA: $WapVpNReS1msQxGwFCoE1Y90QOtiHoOwH0H7

Message bytes:
0 2 -128 0 0 1 0 1 0 0 0 0 15 49 48 51 49 49 49 49 49 49 49 48 51 49 48 56 5 57 57 49 49 49 0 0 16 0 1 5 52 57 49 54 52 0 0 16 0 1 0 0 -88 -64 0 37 36 87 97 112 86 112 78 82 101 83 49 109 115 81 120 71 119 70 67 111 69 49 89 57 48 81 79 116 105 72 111 79 119 72 48 72 55
```

#### Тип AAAA

Клиент:

```
nslookup -type=AAAA google.com 127.0.0.1
╤хЁтхЁ:  UnKnown
Address:  127.0.0.1

Не заслуживающий доверия ответ:
╚ь :     49164
Address:  6e57:7645:5444:534a:4646:5458:4f4b:634f
```

Сервер:

```
Header:
        ID: 1
        Flags:
                QR: 1
                OpCode: 0
                AA: 0
                TC: 0
                RD: 0
                RA: 0
                Z: 0
                RCODE: 4
        QDCOUNT: 1
        ANCOUNT: 0
        NSCOUNT: 0
        ARCOUNT: 0
Question:
        QNAME: [46, 46, 46, 52, 57, 53, 48, 46, 49, 48, 53, 49, 49, 48, 52, 53, 57, 55, 49, 48, 48, 49, 48, 48, 46, 57, 55, 49, 49, 52, 49, 49, 50]
        QTYPE: 12
        QCLASS: 1

Message bytes:
0 1 -128 4 0 1 0 0 0 0 0 0 0 0 0 4 52 57 53 48 16 49 48 53 49 49 48 52 53 57 55 49 48 48 49 48 48 8 57 55 49 49 52 49 49 50 0 0 12 0 1

Header:
        ID: 2
        Flags:
                QR: 1
                OpCode: 0
                AA: 0
                TC: 0
                RD: 0
                RA: 0
                Z: 0
                RCODE: 0
        QDCOUNT: 1
        ANCOUNT: 1
        NSCOUNT: 0
        ARCOUNT: 0
Question:
        QNAME: [49, 48, 51, 49, 49, 49, 49, 49, 49, 49, 48, 51, 49, 48, 56, 46, 57, 57, 49, 49, 49]
        QTYPE: 28
        QCLASS: 1
Answer:
        NAME: 49164
        TYPE: 28
        CLASS: 1
        TTL: 43200
        RDLENGTH: 16
        RDATA: nWvETDSJFFTXOKcOZ1oTjA==

Message bytes:
0 2 -128 0 0 1 0 1 0 0 0 0 15 49 48 51 49 49 49 49 49 49 49 48 51 49 48 56 5 57 57 49 49 49 0 0 28 0 1 5 52 57 49 54 52 0 0 28 0 1 0 0 -88 -64 0 16 110 87 118 69 84 68 83 74 70 70 84 88 79 75 99 79 90 49 111 84 106 65 61 61
```

